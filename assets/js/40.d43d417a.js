(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{683:function(e,a,s){"use strict";s.r(a);var t=s(28),r=Object(t.a)({},(function(){var e=this,a=e.$createElement,s=e._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("p",[e._v("给大家一个 OMV 添加固态缓存的方案。")]),e._v(" "),s("p",[e._v("这算是 OMV 教程的一个番外篇，给 OMV 添加缓存。其实 OMV 系统的面板里，插件里都没有缓存这个选项，就当前的版本 (OMV5)，我们需要自己搞定。")]),e._v(" "),s("p",[e._v("在 google 上搜索，也没有找到现成的教程，只能找到一些线索，其中提到了 dm-cache 和 bcache。")]),e._v(" "),s("p",[e._v("我们都知道，OMV 是基于 Debian 的，只需要知道 Debian 系统上怎么使用固态作为机械硬盘的缓存就可以了，毕竟缓存盘在 Linux 服务器上还是很常见的。")]),e._v(" "),s("p",[e._v("Linux 的缓存方案其实挺多的，其中就有前面提到的 dm-cache 和 bcache，综合考虑之后我决定使用 bcache。")]),e._v(" "),s("h2",{attrs:{id:"硬件介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#硬件介绍"}},[e._v("#")]),e._v(" 硬件介绍")]),e._v(" "),s("p",[e._v("NAS 配置")]),e._v(" "),s("ul",[s("li",[e._v("主板 华擎 IMB-170-V")]),e._v(" "),s("li",[e._v("CPU i5-3380M")]),e._v(" "),s("li",[e._v("内存 金士顿 8G DDR3 1600 笔记本内存 * 2")])]),e._v(" "),s("p",[e._v("硬盘")]),e._v(" "),s("ul",[s("li",[e._v("三星 (型号忘了) 120G 固态 * 1")]),e._v(" "),s("li",[e._v("东芝 P300 3T * 4")]),e._v(" "),s("li",[e._v("朗科 240G 固态 * 1")])]),e._v(" "),s("p",[e._v("其中 4 块机械硬盘组成 RAID5 阵列，120G 固态作为系统盘，240G 固态作为缓存盘。")]),e._v(" "),s("h2",{attrs:{id:"准备工作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#准备工作"}},[e._v("#")]),e._v(" 准备工作")]),e._v(" "),s("p",[e._v("首先需要知道 OMV 的一个注意事项，OMV 网络面板上有的选项，一定要在 OMV 的面板上做，如果你是使用命令行操作的，没有进入 OMV 的数据库，那会影响到后面的操作"),s("sup",{staticClass:"footnote-ref"},[s("a",{attrs:{href:"#fn1",id:"fnref1"}},[e._v("[1]")])]),e._v("。")]),e._v(" "),s("p",[e._v("还要知道，初始化 bcache 的时候，前端缓存和后端仓库，都需要是干净的，如果有数据存在要全部格掉，所以建议在组件 NAS 的时候就搞缓存，如果是使用了一段时间的 NAS，请一定要做好数据备份。")]),e._v(" "),s("p",[e._v("使用 bcache，建议对缓存盘也做好数据保护。")]),e._v(" "),s("p",[e._v("我们先在 OMV 的面板里创建好 RAID，机械盘组建好 RAID5，我在以前的文章里介绍过，这里不在赘述，如果资金充足，并且接口充裕，固态硬盘建议做 RAID1，防止缓存数据丢失。如果资金不足或者是接口不够，也没有关系的，数据是会及时回写的，即使缓存挂掉也最多只是丢掉刚刚写入的数据。")]),e._v(" "),s("p",[e._v("在开始动手之前，请熟读以下几篇文章，注意数据无价吗，开始动手之前请熟读以下文档，如果这篇文章和以下的文档以及相关链接有冲突，请以下面的文档为准，本文没有提到的注意事项和设置选项，请以下面的文档为准。包括稳定里链接的用户文档，FQA，也请熟读。")]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://www.kernel.org/doc/Documentation/bcache.txt",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://www.kernel.org/doc/Documentation/bcache.txt"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"https://bcache.evilpiepirate.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://bcache.evilpiepirate.org/"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"https://wiki.ubuntu.com/ServerTeam/Bcache",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://wiki.ubuntu.com/ServerTeam/Bcache"),s("OutboundLink")],1)])]),e._v(" "),s("p",[e._v("英文不好没关系，用翻译软件一段一段的翻译，不懂的地方就去百度，百度也不懂就去 google，一定要弄懂了，知道自己要设置哪些东西再动手。不要迷信本文，有些地方我可能没讲到，也可能是错的。")]),e._v(" "),s("h2",{attrs:{id:"安装-bcache"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装-bcache"}},[e._v("#")]),e._v(" 安装 bcache")]),e._v(" "),s("p",[e._v("使用 ssh 登录到 nas，安装  "),s("code",[e._v("bcache-tools")])]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt")]),e._v(" update\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" bcache-tools\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("p",[e._v("然后请确保缓存盘和后端都是空的，如果不是空的，请提前清空，使用命令  "),s("code",[e._v("wipefs -a")]),e._v(" 。")]),e._v(" "),s("p",[e._v("然后计算偏移量，原文是这样写的")]),e._v(" "),s("blockquote",[s("p",[e._v("Bcache has a bunch of config options and tunables. The defaults are intended to"),s("br"),e._v("\nbe reasonable for typical desktop and server workloads, but they're not what you"),s("br"),e._v("\nwant for getting the best possible numbers when benchmarking.")])]),e._v(" "),s("blockquote",[s("ul",[s("li",[e._v("Backing device alignment")])])]),e._v(" "),s("blockquote",[s("p",[e._v("The default metadata size in bcache is 8k. If your backing device is"),s("br"),e._v("\nRAID based, then be sure to align this by a multiple of your stride"),s("br"),e._v("\nwidth using  "),s("code",[e._v("make-bcache --data-offset")]),e._v(" . If you intend to expand your"),s("br"),e._v("\ndisk array in the future, then multiply a series of primes by your"),s("br"),e._v("\nraid stripe size to get the disk multiples that you would like.")])]),e._v(" "),s("blockquote",[s("p",[e._v("For example: If you have a 64k stripe size, then the following offset"),s("br"),e._v("\nwould provide alignment for many common RAID5 data spindle counts::"),s("br"),e._v("\n64k * 2 * 2 * 2 * 3 * 3 * 5 *7 bytes = 161280k")])]),e._v(" "),s("blockquote",[s("p",[e._v("That space is wasted, but for only 157.5MB you can grow your RAID 5"),s("br"),e._v("\nvolume to the following data-spindle counts without re-aligning::")])]),e._v(" "),s("blockquote",[s("p",[e._v("3,4,5,6,7,8,9,10,12,14,15,18,20,21 ...")])]),e._v(" "),s("p",[e._v("我根据我自己的实际情况算一下，如果不会算，就直接按最大的 256 算，结果也就是 645120K，这个多大无所谓，就是浪费 650M 的空间，不在乎的。怕浪费直接用他给的 161280k 也没问题。或者是根据自己的实际情况算出来，")]),e._v(" "),s("h3",{attrs:{id:"同时创建后端仓库和缓存盘"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#同时创建后端仓库和缓存盘"}},[e._v("#")]),e._v(" 同时创建后端仓库和缓存盘")]),e._v(" "),s("p",[e._v("然后初始化并绑定缓存盘")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("make-bcache -B /dev/md127 -C /dev/sdc --data-offset 645120k\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("h3",{attrs:{id:"分步创建后端仓库和缓存盘"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分步创建后端仓库和缓存盘"}},[e._v("#")]),e._v(" 分步创建后端仓库和缓存盘")]),e._v(" "),s("p",[e._v("创建后端仓库")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("make-bcache -B /dev/md127 --data-offset 645120k\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("创建缓存盘")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("make-bcache -C /dev/sdc\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("绑定缓存盘，先查看缓存盘的  "),s("code",[e._v("cset.uuid")]),e._v(" ，下面只是其中一种方法")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("ls /sys/fs/bcache/\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("找到 uuid，执行")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("echo <UUID> > /sys/block/bcache<n>/bcache/attach\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("例如")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('echo "a49786fb-226d-41cf-835d-d843c700172d" > /sys/block/bcache0/bcache/attach\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("h2",{attrs:{id:"设置硬盘"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#设置硬盘"}},[e._v("#")]),e._v(" 设置硬盘")]),e._v(" "),s("p",[e._v("不出意外的话，这个时候就可以再 OMV 的面板上看到已经创建好的 bcache 磁盘了，我们在  "),s("code",[e._v("存储器")]),e._v("  ->  "),s("code",[e._v("文件系统")]),e._v("  ->  "),s("code",[e._v("创建")]),e._v("  里，为前面创建的带有缓存的磁盘创建文件系统，并且挂载上，注意这些都要在 OMV 的面板上操作，如果面板一直报错，就重启一次系统。")]),e._v(" "),s("p",[e._v("然后再从  "),s("code",[e._v("访问权限管理")]),e._v("  ->  "),s("code",[e._v("共享文件夹")]),e._v("  中创建共享文件夹。接下来就是正常操作了，没什么特殊的。")]),e._v(" "),s("p",[e._v("如果感觉性能不够，可以改为写缓存模式")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" writeback "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" /sys/block/bcache0/bcache/cache_mode\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("还可以对其他的选项做调整，详情请看 "),s("a",{attrs:{href:"https://www.kernel.org/doc/Documentation/bcache.txt",target:"_blank",rel:"noopener noreferrer"}},[e._v("文档"),s("OutboundLink")],1)]),e._v(" "),s("h2",{attrs:{id:"操作示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#操作示例"}},[e._v("#")]),e._v(" 操作示例")]),e._v(" "),s("h3",{attrs:{id:"删除缓存盘"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#删除缓存盘"}},[e._v("#")]),e._v(" 删除缓存盘")]),e._v(" "),s("p",[e._v("首先需要将硬盘卸载，在 OMV 的管理面板中操作，然后将缓存模式改为  "),s("code",[e._v("writethrough")]),e._v(" ，确定缓存盘里没有数据，再卸载")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("echo writethrough > /sys/block/bcache0/bcache/cache_mode\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("cat /sys/block/bcache0/bcache/state\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("后面输出  "),s("code",[e._v("clean")]),e._v("  即可继续后面的步骤。")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('echo "a49786fb-226d-41cf-835d-d843c700172d" > /sys/block/bcache0/bcache/detach\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("h3",{attrs:{id:"注销缓存盘"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注销缓存盘"}},[e._v("#")]),e._v(" 注销缓存盘")]),e._v(" "),s("p",[e._v("首先按照"),s("a",{attrs:{href:"#%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98%E7%9B%98"}},[e._v("删除缓存盘")]),e._v("步骤删除缓存盘，然后执行")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("echo 1 > /sys/fs/bcache/<UUID>/unregister\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("例如")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("echo 1>/sys/fs/bcache/a49786fb-226d-41cf-835d-d843c700172d/unregister\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("h3",{attrs:{id:"更换缓存盘"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#更换缓存盘"}},[e._v("#")]),e._v(" 更换缓存盘")]),e._v(" "),s("p",[e._v("首先按照"),s("a",{attrs:{href:"#%E6%B3%A8%E9%94%80%E7%BC%93%E5%AD%98%E7%9B%98"}},[e._v("注销缓存盘")]),e._v("步骤，正常注销原有缓存盘，如有必要，关机更换新的缓存盘，然后按照"),s("a",{attrs:{href:"#%E5%88%86%E6%AD%A5%E5%88%9B%E5%BB%BA%E5%90%8E%E7%AB%AF%E4%BB%93%E5%BA%93%E5%92%8C%E7%BC%93%E5%AD%98%E7%9B%98"}},[e._v("分步创建后端仓库和缓存盘")]),e._v("中的步骤，创建新的缓存盘，并将新的缓存盘与 bcache 绑定。")]),e._v(" "),s("hr"),e._v(" "),s("hr",{staticClass:"footnotes-sep"}),e._v(" "),s("section",{staticClass:"footnotes"},[s("ol",{staticClass:"footnotes-list"},[s("li",{staticClass:"footnote-item",attrs:{id:"fn1"}},[s("p",[s("a",{attrs:{href:"https://openmediavault.readthedocs.io/en/5.x/administration/storage/filesystems.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("omv-filesystems"),s("OutboundLink")],1),e._v(" "),s("a",{staticClass:"footnote-backref",attrs:{href:"#fnref1"}},[e._v("↩︎")])])])])])])}),[],!1,null,null,null);a.default=r.exports}}]);